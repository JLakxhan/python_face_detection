{% extends 'includes/layout.html' %}
{% load static %}
{% block content %}
<div class="container">
    <h1>Apply Leave</h1>
    <form  class="employee-form">
        {% csrf_token %}
        
        <div class="create-employee-form">
            <div class="form-field">
                <label for="leave_type">Leave Type <span style="color: red;">*</span></label>
                <select id="leave_type" onchange="updateBalance()">
                    <option value="annual">Annual Leave</option>
                    <option value="casual">Casual Leave</option>
                    <option value="medical">Medical Leave</option>
                    <option value="other">Other Leave</option>
                </select>
            </div>
            <div class="form-field">
                <label for="first_name">Available Balance <span style="color: red;">*</span></label>
                <input type="text" id="available_balance" disabled />
            </div>
            <div class="form-field">
                <label for="start_date">Start Date <span style="color: red;">*</span></label>
                <input type="date" id="start_date" />
            </div>
            <div class="form-field">
                <label for="end_date">End Date <span style="color: red;">*</span></label>
                <input type="date" id="end_date" />
            </div>
            
        
            <!-- Action Buttons -->
            <div class="form-actions">
                <button class="button-dark" type="button" onclick="applyLeave()">Apply Leave</button>
            </div>
        </div>
    </form>
</div>

<style>
 .create-employee-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Two columns per row */
    gap: 15px; /* Reduced gap for better compactness */
    padding: 20px;
    max-width: 900px; /* Wider form to fit all fields */
    margin: 0 auto; /* Center the form */
    background: #ffffff; /* Light background for clarity */
    border-radius: 8px; /* Rounded corners */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Depth for the form */
}

.form-field {
    display: flex;
    flex-direction: column;
}

.form-field label {
    font-size: 14px;
    color: #293963;
    margin-bottom: 5px;
}

.form-field input,
.form-field select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
}

.form-actions {
    grid-column: span 2; /* Spans the entire row */
    text-align: right;
    margin-top: 20px;
}



@media (max-width: 768px) {
    .create-employee-form {
        grid-template-columns: 1fr; /* Single column on smaller screens */
    }
    .form-actions {
        text-align: center;
    }
}

</style>
<script>
    $(document).ready( function () {
        updateBalance();
    } );
    const leaveBalances = {
        annual: {{ leave_balances.annual }},
        casual: {{ leave_balances.casual }},
        medical: {{ leave_balances.medical }},
        other: {{ leave_balances.other }},
    };

    function updateBalance() {
        const leaveType = document.getElementById("leave_type").value;
        const balanceField = document.getElementById("available_balance");
        balanceField.value = leaveBalances[leaveType] || 0; // Update based on the selected type
    }

    function applyLeave(){
        const formData = new FormData();
        leave_type = $("#leave_type").val()
        start_date = $("#start_date").val()
        end_date = $("#end_date").val()

        if(leave_type == '' || start_date == '' || end_date == '' ){
            showToast("Please enter all the required fields.", "error");
        }else{
            const start = new Date(start_date);
            const end = new Date(end_date);

            // Calculate the difference in milliseconds
            const diffInMs = end - start;

            if (diffInMs < 0) {
                showToast("End date cannot be earlier than the start date.", "error");
                return;
            }

            // Convert the difference to days (inclusive)
            const totalDays = (diffInMs / (1000 * 60 * 60 * 24)) + 1;

            if((leave_type == 'annual' && totalDays > leaveBalances.annual) || (leave_type == 'casual' && totalDays > leaveBalances.casual) || (leave_type == 'medical' && totalDays > leaveBalances.medical) || (leave_type == 'other' && totalDays > leaveBalances.other)){
                showToast("Leave balance not enough.", "error");
                return;
            }
            

            formData.append('leave_type', leave_type);
            formData.append('start_date', start_date);
            formData.append('end_date', end_date);

            fetch("/users/create/leave/", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 1) {
                    showToast('Leave applied successfully');
                    setTimeout(function() {
                        location.reload();
                    }, 2000); // 2000 milliseconds = 2 seconds
                } else {
                    showToast(data.data, "error");
                    showToast("Connection error. Please check backend.", "error");
                }
            })
            .catch(error => {
                console.error("Fetch Error:", error);
                showToast("Connection error. Please check backend.", "error");
            });
        }
    }
</script>
{% endblock %}
